<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Audio</title>
</head>

<body>
    <h1>Live MP3 Stream</h1>
    <audio id="audioPlayer" controls autoplay>
        <source src="http://localhost:8080" type="audio/mpeg">
    </audio>

    <script>
        const audioPlayer = document.getElementById('audioPlayer');
        audioPlayer.load();
        audioPlayer.play();

        async function sendNext() {
            console.log("Sending ACK to server...");
            try {
                await fetch('http://localhost:8080', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cmd: 'NEXT' })
                });
                console.log("NEXT sent successfully!");
            } catch (error) {
                console.error("Error sending NEXT:", error);
            }
        }

        audioPlayer.addEventListener('timeupdate', () => {
            if (Math.round(audioPlayer.duration) <= Math.round(audioPlayer.currentTime)) {
                sendNext();
                audioPlayer.currentTime = 0;
                audioPlayer.load();
                audioPlayer.play();
            }
        });
    </script>
    <br>
    <button id="play">PLAY</button>
    <select id="trackSelector">
    </select>

    <script>
        const trackSelector = document.getElementById('trackSelector');

        async function getTracks() {
            trackSelector.childNodes.forEach(option => {
                trackSelector.removeChild(option);
            });
            console.log("Fetching tracks from server...");
            try {
                await fetch('http://localhost:8080/tracks')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(track => {
                            const option = document.createElement('option');
                            option.value = track;
                            option.text = track;
                            trackSelector.appendChild(option);
                        });
                    });
            } catch (error) {
                console.error("Error fetching tracks:", error);
            }
        }

        trackSelector.addEventListener('click', getTracks);
    </script>
    <script>
        const play = document.getElementById('play');
        const selectedTrack = document.getElementById('trackSelector').value;

        async function sendPlay() {
            console.log("Sending PLAY to server...");
            try {
                await fetch('http://localhost:8080', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cmd: 'PLAY', track: selectedTrack })
                });
                console.log("PLAY sent successfully!");
            } catch (error) {
                console.error("Error sending PLAY:", error);
            }
        }

        play.addEventListener('click', () => {
            sendPlay();
            audioPlayer.play();
        });
    </script>
    <button id="skip">SKIP</button>
    <script>
        const skip = document.getElementById('skip');

        async function sendSkip() {
            console.log("Sending SKIP to server...");
            try {
                await fetch('http://localhost:8080', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cmd: 'SKIP' })
                });
                console.log("ACK sent successfully!");
            } catch (error) {
                console.error("Error sending SKIP:", error);
            }
        }

        skip.addEventListener('click', () => {
            sendSkip();
            audioPlayer.currentTime = 0;
            audioPlayer.load();
        });
    </script>
    <button id="upload">UPLOAD</button>
    <button id="queue">QUEUE</button>
</body>

</html>